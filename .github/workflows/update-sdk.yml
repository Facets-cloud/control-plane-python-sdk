name: Update Python SDK

on:
  workflow_dispatch:
    inputs:
      api_url:
        description: 'API docs URL (defaults to facetsdemo.console.facets.cloud)'
        required: false
        default: 'facetsdemo.console.facets.cloud'
        type: string

jobs:
  update-sdk:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Download swagger-codegen CLI
        run: |
          wget https://repo1.maven.org/maven2/io/swagger/codegen/v3/swagger-codegen-cli/3.0.68/swagger-codegen-cli-3.0.68.jar -O swagger-codegen-cli.jar

      - name: Fetch latest API docs
        run: |
          curl https://${{ inputs.api_url }}/v2/api-docs -o api-docs-raw.json

      - name: Install jq
        run: |
          sudo apt-get install -y jq

      - name: Format JSON
        run: |
          jq . api-docs-raw.json > api-docs-fixed.json

      - name: Generate updated SDK
        run: |
          java -jar swagger-codegen-cli.jar generate -i api-docs-fixed.json -l python -o . -c swagger-config.json

      - name: Create VERSION file if it doesn't exist
        run: |
          if [ ! -f VERSION ]; then
            echo "1.1.0" > VERSION
          fi

      - name: Customize setup.py
        run: |
          cat > setup.py << 'EOF'
          from setuptools import setup, find_packages  # noqa: H301
          
          with open("VERSION", "r") as version_file:
              version = version_file.read().strip()
              
          NAME = "facets-control-plane-sdk"
          VERSION = version
          REQUIRES = ["urllib3 >= 1.15", "six >= 1.10", "certifi", "python-dateutil"]
          
          with open("README.md", "r", encoding="utf-8") as fh:
              long_description = fh.read()
              
          setup(
              name=NAME,
              version=VERSION,
              description="Api Documentation",
              long_description=long_description,
              long_description_content_type="text/markdown",
              author="Anuj Hydrabadi",
              author_email="anuj.hydrabadi@facets.cloud",
              url="https://github.com/Facets-cloud/control-plane-python-sdk",
              keywords=["Swagger", "Api Documentation"],
              install_requires=REQUIRES,
              packages=find_packages(),
              include_package_data=True,
              python_requires=">=3.10",
              classifiers=[
                  "Programming Language :: Python :: 3",
                  "License :: OSI Approved :: MIT License",
                  "Operating System :: OS Independent",
              ],
          )
          EOF

      - name: Remove temporary files
        run: |
          rm api-docs-raw.json api-docs-fixed.json swagger-codegen-cli.jar

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "Update Python SDK from latest API docs"
          title: "Update Python SDK from latest API docs"
          body: |
            This PR updates the Python SDK with the latest API definitions from:
            https://${{ inputs.api_url }}/v2/api-docs
            
            Changes were automatically generated by the GitHub Actions workflow.
          branch: update-sdk
          branch-suffix: timestamp
          delete-branch: true
          base: master

      - name: Check outputs
        if: ${{ steps.cpr.outputs.pull-request-number }}
        run: |
          echo "Pull Request Number - ${{ steps.cpr.outputs.pull-request-number }}"
          echo "Pull Request URL - ${{ steps.cpr.outputs.pull-request-url }}"
